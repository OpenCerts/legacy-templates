import { Selector } from "testcafe";
import { readFileSync } from "fs";
import { join } from "path";
import { getData } from "@govtechsg/open-attestation";

fixture("Ngee Ann Polytechnic").page`http://localhost:3000`;

const Certificate = "./NP_Certs_SC_NEA_2019.opencert";

const RenderedCertificate = Selector("#rendered-certificate");

const validateTextContent = async (t, component, texts) =>
  texts.reduce(
    async (prev, curr) => t.expect(component.textContent).contains(curr),
    Promise.resolve()
  );

test("NP-CET-SC-NEA 2019 certificate is rendered correctly", async t => {
  // Inject javascript and execute window.opencerts.renderDocument
  const certificateContent = getData(
    JSON.parse(readFileSync(join(__dirname, Certificate)).toString())
  );
  await t.eval(() => window.opencerts.renderDocument(certificateContent), {
    dependencies: { certificateContent }
  });

  // Check content of window.opencerts.templates
  const container = Selector("#rendered-certificate .container");
  await container(); // wait for document to be rendered
  const templates = await t.eval(() => window.opencerts.getTemplates());
  await t
    .expect(templates)
    .eql([{ id: "certificate", label: "Certificate", template: undefined }]);

  // Certificate tab content
  await validateTextContent(t, RenderedCertificate, [
    "Student Name SC NEA Cert 2019",
    "having passed all required assessments",
    "of the 40-hour course",
    "Certificate of Performance",
    "Basic Laser Radiation Safety Course",
    "ABC Name 1",
    "DIRECTOR, SCHOOL OF ENGINEERING",
    "NGEE ANN POLYTECHNIC",
    "ABC Name 2",
    "CHIEF EXECUTIVE OFFICER",
    "THE NATIONAL ENVIRONMENT AGENCY",
    "30 May 2019",
    "NPCETNEA0001"
  ]);
});
